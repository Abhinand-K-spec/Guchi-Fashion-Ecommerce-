<%- include('../partials/user/header') %>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order Details - Guchi Fashion</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <style>
    body {
      background: url('/img/background.svg');
      background-color: #f4f6f9;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    a { text-decoration: none; }
    .order-header {
      background-color: #fff; padding: 25px; border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.07); margin-bottom: 30px;
    }
    .product-card {
      background: #fff; padding: 20px; border-radius: 10px; margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .product-card img { max-height: 120px; object-fit: cover; border-radius: 8px; }
    .btn-custom { transition: 0.3s; }
    .btn-custom:hover { transform: scale(1.05); }
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; max-width: 400px; }
  </style>
</head>

<body>

<div class="toast-container"></div>

<div class="container py-5">

  <!-- ORDER HEADER -->
  <div class="order-header">
    <h3 class="mb-3">Order Details</h3>
    <p><strong>Order ID:</strong> <%= order.OrderId %></p>
    <p><strong>Date:</strong> <%= new Date(order.OrderDate).toLocaleString() %></p>
    <p><strong>Return Policy:</strong> 7-day return policy</p>
    <p><strong>Delivery Charge:</strong> ₹40</p>
    <p><strong>Payment Method:</strong> <%= order.PaymentMethod %></p>

    <% if (order.PaymentMethod === 'Online' && order.PaymentStatus !== 'Completed' && order.Status === 'Pending') { %>
      <button class="btn btn-danger btn-sm btn-custom mt-3" id="retry-payment-btn" data-order-id="<%= order._id %>">
        Retry Payment
      </button>
    <% } %>
  </div>

  <!-- ORDER ITEMS -->
  <% order.Items.forEach(item => { 
    const product = item.product || {};
    const image = product.Image?.[0] ? `${product.Image[0]}` : '/images/default.jpg';

    const unitPrice = item.price || 0;  
    const originalPrice = item.originalPrice || unitPrice;
    const itemDiscount = item.itemDiscount || 0;
    const qty = item.quantity;

    const subtotal = (unitPrice * qty);
    const taxAmount = (subtotal * 0.05) / 100;
    const subtotalWithTax = subtotal + taxAmount;
  %>

  <div class="product-card row g-3 align-items-center" id="item-<%= item._id %>">

    <!-- IMAGE -->
    <div class="col-md-2 text-center">
      <img src="<%= image %>" class="img-fluid" alt="Product Image" />
    </div>

    <!-- DETAILS -->
    <div class="col-md-7">
      <h5><%= product.productName %></h5>
      <p><strong>Quantity:</strong> <%= qty %></p>
      <p><strong>Size:</strong> <%= item.size %></p>

      <% if (itemDiscount > 0) { %>
        <p class="text-success mb-1"><strong>Item Discount:</strong> -₹<%= itemDiscount.toFixed(2) %></p>
        <p class="text-muted mb-1"><del>MRP (per unit): ₹<%= originalPrice.toFixed(2) %></del></p>
      <% } %>

      <p class="mb-1"><strong>Subtotal:</strong> ₹<%= subtotal.toFixed(2) %></p>
      <p class="mb-1"><strong>Tax:</strong> ₹<%= taxAmount.toFixed(2) %></p>
      <p class="mb-1"><strong>Total:</strong> ₹<%= (subtotalWithTax + 40) .toFixed(2) %></p>

      <p><strong>Status:</strong>
        <span class="badge 
          <% if(item.status === 'Delivered') { %> bg-success
          <% } else if(item.status === 'Cancelled') { %> bg-danger
          <% } else if(item.status === 'Shipped') { %> bg-primary
          <% } else if(item.status === 'OutForDelivery') { %> bg-info text-dark
          <% } else if(item.status === 'Returned') { %> bg-warning text-dark
          <% } else { %> bg-secondary <% } %>"
          id="item-status-<%= item._id %>">
          <%= item.status %>
        </span>
      </p>

      <% if (item.cancelReason) { %>
        <p class="text-muted"><strong>Cancel Reason:</strong> <%= item.cancelReason %></p>
      <% } %>

      <% if (item.returnReason) { %>
        <p class="text-muted"><strong>Return Reason:</strong> <%= item.returnReason %></p>
      <% } %>

      <% if (item.returnRequestedAt) { %>
        <p class="text-muted"><strong>Return Requested At:</strong> <%= new Date(item.returnRequestedAt).toLocaleString() %></p>
      <% } %>

    </div>

    <!-- ACTIONS -->
    <div class="col-md-3 text-end">

      <% if (item.status === 'Pending' && item.returnStatus === 'NotRequested' && order.PaymentStatus === 'Completed') { %>
        <form class="cancel-item-form mb-2" 
              data-item-id="<%= item._id %>" 
              data-action="/order/<%= order._id %>/cancel-item/<%= item._id %>">

          <input type="text" name="reason" class="form-control mb-2 cancel-reason" placeholder="Reason required" required />
          <div class="invalid-feedback">Please provide a reason.</div>

          <button type="submit" class="btn btn-danger btn-sm btn-custom">Cancel Item</button>
        </form>
      <% } %>

      <% if (item.status === 'Delivered' && item.returnStatus === 'NotRequested') { %>
        <button class="btn btn-warning btn-sm btn-custom return-item-btn mb-2" 
                data-item-id="<%= item._id %>" 
                data-bs-toggle="modal" 
                data-bs-target="#returnOrderModal">
          Request Return
        </button>
      <% } %>

      <% if (item.status === 'Delivered') { %>
        <a href="/order/<%= order._id %>/invoice"
           class="btn btn-outline-secondary btn-sm btn-custom mb-2">
          <i class="fas fa-download"></i> Download Invoice
        </a>
      <% } %>

      <% if (item.returnStatus !== 'NotRequested') { %>
        <p><strong>Return Status:</strong>
          <span class="badge 
            <% if(item.returnStatus === 'Return Requested') { %> bg-warning text-dark
            <% } else if(item.returnStatus === 'Request Approved') { %> bg-success
            <% } else if(item.returnStatus === 'Request Denied') { %> bg-danger
            <% } %>">
            <%= item.returnStatus %>
          </span>
        </p>
      <% } %>

    </div>
  </div>
  <% }) %>

  <!-- FULL ORDER CANCEL -->
  <% if (
      order.Items.length > 1 &&
      order.Items.every(x => x.status === 'Pending' && x.returnStatus === 'NotRequested') &&
      order.PaymentStatus === 'Completed'
  ) { %>
    <button class="btn btn-danger btn-custom cancel-full-order-btn mt-3"
            data-bs-toggle="modal"
            data-bs-target="#cancelFullOrderModal">
      Cancel Full Order
    </button>
  <% } %>

</div>


<!-- ============================
      RETURN MODAL
=============================== -->
<div class="modal fade" id="returnOrderModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <form id="return-order-form" class="modal-content p-4">
      <h5 class="modal-title">Request Return</h5>
      <label class="mt-3">Select reason:</label>
      <select name="reason" id="return-reason" class="form-select" required>
        <option value="">Select</option>
        <option value="Changed my mind">Changed my mind</option>
        <option value="Product damaged">Product damaged</option>
        <option value="Wrong product received">Wrong product received</option>
      </select>
      <div class="invalid-feedback">Reason is required.</div>

      <div class="mt-3 text-end">
        <button class="btn btn-warning">Submit Return</button>
      </div>
    </form>
  </div>
</div>


<!-- ============================
      CANCEL FULL ORDER MODAL
=============================== -->
<div class="modal fade" id="cancelFullOrderModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <form id="cancel-full-order-form"
          class="modal-content p-4"
          data-action="/order/<%= order._id %>/cancel">

      <h5>Cancel full order?</h5>
      <input type="text" id="cancel-full-reason" class="form-control mt-2" placeholder="Reason required" required />
      <div class="invalid-feedback">Reason is required.</div>

      <div class="mt-3 text-end">
        <button class="btn btn-danger">Confirm</button>
      </div>
    </form>
  </div>
</div>



<!-- BOOTSTRAP JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>

// toast helper
function showToast(type, message) {
  const html = `
    <div class="toast text-white bg-${type} border-0">
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button class="btn-close btn-close-white me-2" data-bs-dismiss="toast"></button>
      </div>
    </div>
  `;
  document.querySelector('.toast-container').insertAdjacentHTML('beforeend', html);
  const toast = new bootstrap.Toast(document.querySelector('.toast:last-child'));
  toast.show();
}


// ===================
// INDIVIDUAL ITEM CANCEL
// ===================
document.querySelectorAll('.cancel-item-form').forEach(form => {
  form.addEventListener('submit', async e => {
    e.preventDefault();

    const reason = form.querySelector('.cancel-reason').value.trim();
    if (!reason) return showToast('danger', 'Reason required');

    const url = form.dataset.action;
    const itemId = form.dataset.itemId;

    try {
      const res = await axios.post(url, { reason });
      if (!res.data.success) return showToast('danger', res.data.message);

      const card = document.getElementById(`item-${itemId}`);
      card.querySelector('.cancel-item-form')?.remove();
      card.querySelector('.return-item-btn')?.remove();

      const badge = card.querySelector(`#item-status-${itemId}`);
      badge.className = 'badge bg-danger';
      badge.textContent = 'Cancelled';

      showToast('success', 'Item cancelled');
    } catch (err) {
      showToast('danger', 'Error cancelling item');
    }
  });
});


// ===================
// RETURN REQUEST
// ===================
document.getElementById('return-order-form')?.addEventListener('submit', async e => {
  e.preventDefault();

  const reason = document.getElementById('return-reason').value;
  const url = e.target.dataset.action;
  const itemId = e.target.dataset.itemId;

  if (!reason) return showToast('danger', 'Reason required');

  try {
    const res = await axios.post(url, { reason });

    if (!res.data.success) return showToast('danger', res.data.message);

    const card = document.getElementById(`item-${itemId}`);
    card.querySelector('.return-item-btn')?.remove();

    const badge = card.querySelector(`#item-status-${itemId}`);
    badge.className = 'badge bg-warning text-dark';
    badge.textContent = 'Return Requested';

    showToast('success', 'Return request placed');
  } catch (err) {
    showToast('danger', 'Error submitting return');
  }
});


// ===================
// CANCEL FULL ORDER
// ===================
document.getElementById('cancel-full-order-form')?.addEventListener('submit', async e => {
  e.preventDefault();

  const reason = document.getElementById('cancel-full-reason').value.trim();
  const url = e.target.dataset.action;

  if (!reason) return showToast('danger', 'Reason required');

  try {
    const res = await axios.post(url, { reason });

    if (!res.data.success) return showToast('danger', res.data.message);

    document.querySelectorAll('.product-card').forEach(card => {
      card.querySelector('.cancel-item-form')?.remove();
      card.querySelector('.return-item-btn')?.remove();

      const badge = card.querySelector('[id^="item-status-"]');
      if (badge) {
        badge.className = 'badge bg-danger';
        badge.textContent = 'Cancelled';
      }
    });

    showToast('success', 'Order cancelled');
  } catch (err) {
    showToast('danger', 'Error cancelling order');
  }
});


// ===================
// RETRY PAYMENT
// ===================
const retryBtn = document.getElementById('retry-payment-btn');
if (retryBtn) {
  retryBtn.addEventListener('click', async () => {
    const orderId = retryBtn.dataset.orderId;

    try {
      const res = await axios.post('/retry-payment', { orderId });

      if (!res.data.success) {
        showToast('danger', res.data.message);
        return;
      }

      const order = res.data.order;

      const options = {
        key: "<%= process.env.RAZORPAY_KEY_ID %>",
        order_id: order.id,
        amount: order.amount,
        currency: "INR",
        name: "Guchi Fashion",
        image: "/guchi-logo.png",
        handler: async function (paymentResult) {
          const verify = await axios.post('/verify-retry-payment', {
            razorpay_payment_id: paymentResult.razorpay_payment_id,
            razorpay_order_id: paymentResult.razorpay_order_id,
            razorpay_signature: paymentResult.razorpay_signature,
            orderId: orderId
          });

          if (verify.data.success) {
            showToast('success', 'Payment successful');
            setTimeout(() => location.reload(), 800);
          } else {
            showToast('danger', verify.data.message);
          }
        },
        theme: { color: "#28a745" }
      };

      new Razorpay(options).open();

    } catch (err) {
      showToast('danger', "Retry payment error");
    }

  });
}

</script>

<footer class="text-center mt-5">
  <%- include('../partials/user/footer') %>
</footer>

</body>
