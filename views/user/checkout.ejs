<%- include('../partials/user/header') %>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= typeof pageTitle !== 'undefined' ? pageTitle : 'My E-Commerce Site' %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/styles/style.css" />
  <link rel="icon" href="/images/favicon.png" type="image/png" />
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    a { text-decoration: none; }
    .edit-link { font-size: 0.9rem; }
    .price-container { display: flex; align-items: center; gap: 8px; }
    .product-price { color: #000; font-weight: bold; }
    .regular-price { font-size: 0.9rem; color: #999; text-decoration: line-through; }
    .coupon-message { color: #28a745; font-size: 0.9rem; margin-bottom: 1rem; }
    .item-discount { color: #28a745; font-size: 0.9rem; }
    .coupon-input-container { display: flex; gap: 10px; margin-bottom: 1rem; }
    .coupon-input { flex: 1; max-width: 200px; }
    .coupon-error { color: #dc3545; font-size: 0.9rem; margin-top: 0.5rem; }
    .coupon-success { color: #28a745; font-size: 0.9rem; margin-top: 0.5rem; }
    .coupon-eligibility { font-size: 0.8rem; color: #6c757d; }
    .payment-method-container { margin-top: 1rem; }
    .payment-error { color: #dc3545; font-size: 0.9rem; margin-top: 0.5rem; }
  </style>
</head>

<body>
  <div class="container mt-5">
    <h3>Checkout</h3>
    <form action="/place-order" method="POST" id="checkoutForm">
      <div class="row">
        <!-- Address Section -->
        <div class="col-md-6">
          <h5>Delivery Address</h5>
          <% if (addresses.length > 0) { %>
            <% addresses.forEach((address, i) => { %>
              <div class="form-check mb-3 border rounded p-2">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <input class="form-check-input me-2" type="radio" name="selectedAddressId" value="<%= address._id %>" <%= i === 0 ? 'checked' : '' %> required>
                    <label class="form-check-label">
                      <strong><%= address.name %></strong><br>
                      <%= address.town %>, <%= address.city %>, <%= address.state %> - <%= address.postCode %><br>
                      Phone: <%= address.phone %><br>
                      <% if (address.alternativePhone) { %>
                        Alt: <%= address.alternativePhone %>
                      <% } %>
                    </label>
                  </div>
                  <div>
                    <a href="/edit-address/<%= address._id %>" class="btn btn-sm btn-outline-secondary edit-link">
                      <i class="fas fa-edit"></i>
                    </a>
                  </div>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p>No address found.</p>
          <% } %>
          <a href="/add-address" class="btn btn-sm btn-outline-primary mt-2">
            <i class="fas fa-plus"></i> Add New Address
          </a>
        </div>

        <!-- Order Summary -->
        <div class="col-md-6">
          <h5>Order Summary</h5>
          <% cartItems.forEach(item => { %>
            <div class="d-flex align-items-center mb-3 border rounded p-2">
              <img src="<%= item.image %>" width="60" class="me-2 rounded">
              <div>
                <p class="mb-1"><strong><%= item.name %></strong></p>
                <div class="price-container">
                  <p class="mb-1">Qty: <%= item.quantity %> | 
                    <span class="product-price">₹<%= item.price.toFixed(2) %></span>
                    <% if (item.itemDiscount > 0) { %>
                      <span class="regular-price">₹<%= item.originalPrice.toFixed(2) %></span>
                      <span class="item-discount">(₹<%= item.itemDiscount.toFixed(2) %> OFF)</span>
                    <% } %>
                  </p>
                </div>
                <p class="mb-0">Item Total: <%= item.itemTotal.toFixed(2) %></p>
                <% if (item.stock === 0 || item.stock < item.quantity) { %>
                  <p class="mb-0 text-danger">Out of stock</p>
                <% } %>
              </div>
            </div>
          <% }) %>

          <hr>
          <% if (subtotal > 1000) { %>
            <p class="coupon-message">Eligible for a coupon! Enter a code or view available coupons.</p>
          <% } %>
          <div class="coupon-input-container">
            <input type="text" id="couponInput" class="form-control coupon-input" placeholder="Enter coupon code" name="coupon">
            <button type="button" id="couponButton" class="btn btn-primary">Apply</button>
          </div>
          <p id="couponError" class="coupon-error" style="display: none;"></p>
          <p id="couponSuccess" class="coupon-success" style="display: none;"></p>
          <button type="button" class="btn btn-outline-primary mb-3" data-bs-toggle="modal" data-bs-target="#couponModal">
            View Available Coupons
          </button>
          <p><strong>Subtotal:</strong> ₹<span id="subtotal"><%= subtotal.toFixed(2) %></span></p>
          <p><strong>Item Discount:</strong> ₹<span id="itemDiscount"><%= totalItemDiscount.toFixed(2) %></span></p>
          <p><strong>Coupon Discount:</strong> ₹<span id="discount"><%= discount.toFixed(2) %></span></p>
          <p><strong>Taxes:</strong> ₹<span id="tax"><%= tax.toFixed(2) %></span></p>
          <p><strong>Delivery Charge:</strong> ₹<span id="deliveryCharge"><%= deliveryCharge.toFixed(2) %></span></p>
          <p><strong>Final Total:</strong> ₹<span id="finalTotal"><%= finalTotal.toFixed(2) %></span></p>

          <!-- Payment Method Selection -->
          <div class="payment-method-container">
            <h5>Payment Method</h5>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="paymentMethod" id="paymentCOD" value="COD" checked required>
              <label class="form-check-label" for="paymentCOD">
                Cash on Delivery
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="paymentMethod" id="paymentOnline" value="Online">
              <label class="form-check-label" for="paymentOnline">
                Online Payment
              </label>
            </div>
            <p id="paymentError" class="payment-error" style="display: none;"></p>
          </div>

          <!-- Hidden Inputs for Razorpay -->
          <input type="hidden" name="razorpayPaymentId" id="razorpayPaymentId">
          <input type="hidden" name="razorpayOrderId" id="razorpayOrderId">
          <input type="hidden" name="razorpaySignature" id="razorpaySignature">

          <!-- Coupon Modal -->
          <div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="couponModalLabel">Available Coupons</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <% if (coupons && coupons.length > 0) { %>
                    <ul class="list-group">
                      <% coupons.forEach(coupon => { %>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                          <div>
                            <strong><%= coupon.CouponCode || 'N/A' %></strong><br>
                            <%= coupon.Discount ? coupon.Discount + '% OFF' : 'No discount specified' %>
                            <% if (coupon.MinCartValue) { %>
                              <span class="coupon-eligibility">
                                (Min: ₹<%= coupon.MinCartValue %> <%= coupon.MinCartValue > subtotal ? ', Not eligible' : '' %>)
                              </span>
                            <% } %>
                            <% if (coupon.MaxCartValue) { %>
                              <span class="coupon-eligibility">
                                (Max: ₹<%= coupon.MaxCartValue %>)
                              </span>
                            <% } %>
                            <% if (coupon.ExpiryDate) { %>
                              <span class="coupon-eligibility">
                                (Expires: <%= new Date(coupon.ExpiryDate).toLocaleDateString() %>)
                              </span>
                            <% } %>
                          </div>
                          <button class="btn btn-sm btn-outline-primary copy-coupon" data-code="<%= coupon.CouponCode || '' %>">Copy</button>
                        </li>
                      <% }) %>
                    </ul>
                  <% } else { %>
                    <p>No coupons available at this time.</p>
                  <% } %>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>

          <% const hasOutOfStock = cartItems.some(item => item.stock === 0 || item.stock < item.quantity); %>
          <% if (hasOutOfStock) { %>
            <p class="text-danger">Please remove out-of-stock items to proceed.</p>
          <% } %>
          <button type="submit" class="btn btn-success w-100 mt-3" id="placeOrderButton" <%= hasOutOfStock ? 'disabled' : '' %>>
            <i class="fas fa-shopping-bag me-1"></i> Place Order (Cash on Delivery)
          </button>
        </div>
      </div>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const couponInput = document.getElementById('couponInput');
      const couponButton = document.getElementById('couponButton');
      const couponError = document.getElementById('couponError');
      const couponSuccess = document.getElementById('couponSuccess');
      const subtotalEl = document.getElementById('subtotal');
      const itemDiscountEl = document.getElementById('itemDiscount');
      const discountEl = document.getElementById('discount');
      const taxEl = document.getElementById('tax');
      const deliveryChargeEl = document.getElementById('deliveryCharge');
      const finalTotalEl = document.getElementById('finalTotal');
      const checkoutForm = document.getElementById('checkoutForm');
      const placeOrderButton = document.getElementById('placeOrderButton');
      const paymentCOD = document.getElementById('paymentCOD');
      const paymentOnline = document.getElementById('paymentOnline');
      const paymentError = document.getElementById('paymentError');
      const razorpayPaymentId = document.getElementById('razorpayPaymentId');
      const razorpayOrderId = document.getElementById('razorpayOrderId');
      const razorpaySignature = document.getElementById('razorpaySignature');

      const originalSubtotal = <%= subtotal %>;
      const originalItemDiscount = <%= totalItemDiscount %>;
      const originalTax = <%= tax %>;
      const deliveryCharge = <%= deliveryCharge %>;
      const userId = '<%= userId || "" %>';
      const razorpayKey = '<%= process.env.RAZORPAY_KEY_ID %>'; // Ensure this is set in backend
      let appliedCouponCode = '';
      let orderId = ''; // Added from second code

      console.log('Checkout script loaded', { userId, couponButton: !!couponButton, razorpayKey });

      if (!couponButton) {
        console.error('Coupon button not found');
        couponError.textContent = 'Coupon button not found. Please refresh the page.';
        couponError.style.display = 'block';
        return;
      }

      if (!userId) {
        console.error('User ID not defined');
        couponError.textContent = 'Please log in to apply coupons.';
        couponError.style.display = 'block';
        return;
      }

      // Update Place Order button text based on payment method
      const updatePlaceOrderButton = () => {
        if (paymentCOD.checked) {
          placeOrderButton.innerHTML = '<i class="fas fa-shopping-bag me-1"></i> Place Order (Cash on Delivery)';
        } else if (paymentOnline.checked) {
          placeOrderButton.innerHTML = '<i class="fas fa-credit-card me-1"></i> Proceed to Payment (Online)';
        }
      };

      // Initialize button text
      updatePlaceOrderButton();

      // Update button text on payment method change
      paymentCOD.addEventListener('change', updatePlaceOrderButton);
      paymentOnline.addEventListener('change', updatePlaceOrderButton);

      // Handle form submission
      checkoutForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('Form submission initiated', { paymentMethod: paymentCOD.checked ? 'COD' : 'Online' });

        if (!paymentCOD.checked && !paymentOnline.checked) {
          paymentError.textContent = 'Please select a payment method.';
          paymentError.style.display = 'block';
          console.error('No payment method selected');
          return;
        }

        paymentError.style.display = 'none';

        if (paymentOnline.checked) {
          try {
            // Send request to create Razorpay order
            console.log('Online payment');
            const response = await fetch('/place-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                userId,
                selectedAddressId: document.querySelector('input[name="selectedAddressId"]:checked').value,
                coupon: couponInput.value.trim(),
                paymentMethod: 'Online',
                finalTotal: parseFloat(finalTotalEl.textContent)
              })
            });

            const result = await response.json();
            console.log('Place order response:', result);

            if (!response.ok || !result.success) {
              paymentError.textContent = result.message || 'Failed to initiate payment.';
              paymentError.style.display = 'block';
              return;
            }

            orderId = result.order.id; // Added from second code

            // Open Razorpay checkout
            const options = {
              key: razorpayKey,
              amount: result.order.amount,
              currency: 'INR',
              name: 'My E-Commerce Site',
              description: 'Order Payment',
              image: '/guchi-logo.png',
              order_id: result.order.id,
              handler: async function (response) {
                console.log('Payment success:', response);
                // Set hidden inputs for verification
                razorpayPaymentId.value = response.razorpay_payment_id;
                razorpayOrderId.value = response.razorpay_order_id;
                razorpaySignature.value = response.razorpay_signature;

                // Verify payment with backend
                try {
                  const verifyResponse = await fetch('/verify-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      razorpay_payment_id: response.razorpay_payment_id,
                      razorpay_order_id: response.razorpay_order_id,
                      razorpay_signature: response.razorpay_signature,
                      userId,
                      selectedAddressId: document.querySelector('input[name="selectedAddressId"]:checked').value,
                      coupon: couponInput.value.trim(),
                      finalTotal: parseFloat(finalTotalEl.textContent)
                    })
                  });

                  const verifyResult = await verifyResponse.json();
                  console.log('Payment verification response:', verifyResult);

                  if (verifyResult.success) {
                    // Redirect to order confirmation (updated from second code)
                    window.location.href = '/order-success/' + verifyResult.orderId;
                  } else {
                    paymentError.textContent = verifyResult.message || 'Payment verification failed.';
                    paymentError.style.display = 'block';
                  }
                } catch (err) {
                  console.error('Payment verification error:', err);
                  paymentError.textContent = 'Error verifying payment. Please try again.';
                  paymentError.style.display = 'block';
                }
              },
              prefill: {
                name: '<%= addresses[0]?.name || "" %>',
                contact: '<%= addresses[0]?.phone || "" %>',
                email: 'usermail'
              },
              notes: {
                address: '<%= addresses[0]?.town + ", " + addresses[0]?.city + ", " + addresses[0]?.state + " - " + addresses[0]?.postCode || "" %>'
              },
              theme: {
                color: '#28a745'
              },
              modal: {
                ondismiss: function () {
                  console.log('Razorpay checkout dismissed');
                  paymentError.textContent = 'Payment cancelled. Please try again.';
                  paymentError.style.display = 'block';
                }
              }
            };

            const rzp = new Razorpay(options);
            rzp.on('payment.failed', (response) => {
              console.error('Payment failed:', response.error);
              paymentError.textContent = response.error.description || 'Payment failed. Please try again.';
              paymentError.style.display = 'block';
              window.location.href = `/order-failure/${orderId}`; // Updated from second code
            });
            rzp.open();
          } catch (err) {
            console.error('Error initiating online payment:', err);
            paymentError.textContent = 'Error initiating payment. Please try again.';
            paymentError.style.display = 'block';
          }
        } else {
          // COD: Submit form normally
          checkoutForm.submit();
        }
      });

      // Copy coupon code to clipboard
      document.getElementById('couponModal').addEventListener('click', function(e) {
        if (e.target.classList.contains('copy-coupon')) {
          e.preventDefault();
          const code = e.target.dataset.code;
          console.log('Attempting to copy coupon code:', code);

          if (!code) {
            console.error('No coupon code in data-code attribute');
            couponError.textContent = 'No coupon code available to copy.';
            couponError.style.display = 'block';
            couponSuccess.style.display = 'none';
            return;
          }

          try {
            if (navigator.clipboard && window.isSecureContext) {
              navigator.clipboard.writeText(code).then(() => {
                console.log('Coupon code copied via clipboard API:', code);
                couponInput.value = code;
                e.target.textContent = 'Copied!';
                setTimeout(() => e.target.textContent = 'Copy', 2000);
                couponError.style.display = 'none';
                couponSuccess.textContent = 'Coupon code copied!';
                couponSuccess.style.display = 'block';
                setTimeout(() => couponSuccess.style.display = 'none', 3000);
                const modal = bootstrap.Modal.getInstance(document.getElementById('couponModal'));
                modal.hide();
              }).catch(err => {
                throw new Error(`Clipboard API failed: ${err.message}`);
              });
            } else {
              const textarea = document.createElement('textarea');
              textarea.value = code;
              textarea.style.position = 'fixed';
              textarea.style.opacity = '0';
              document.body.appendChild(textarea);
              textarea.select();
              try {
                document.execCommand('copy');
                console.log('Coupon code copied via execCommand:', code);
                couponInput.value = code;
                e.target.textContent = 'Copied!';
                setTimeout(() => e.target.textContent = 'Copy', 2000);
                couponError.style.display = 'none';
                couponSuccess.textContent = 'Coupon code copied!';
                couponSuccess.style.display = 'block';
                setTimeout(() => couponSuccess.style.display = 'none', 3000);
                const modal = bootstrap.Modal.getInstance(document.getElementById('couponModal'));
                modal.hide();
              } finally {
                document.body.removeChild(textarea);
              }
            }
          } catch (err) {
            console.error('Copy error:', err);
            couponError.textContent = 'Failed to copy coupon code. Please try again.';
            couponError.style.display = 'block';
            couponSuccess.style.display = 'none';
          }
        }
      });

      // Handle coupon apply/remove
      couponButton.addEventListener('click', async function(e) {
        e.preventDefault();
        console.log('Coupon button clicked', { buttonText: this.textContent, couponCode: couponInput.value });

        if (this.textContent.trim() === 'Apply') {
          const couponCode = couponInput.value.trim().toUpperCase();
          if (!couponCode) {
            console.error('No coupon code entered');
            couponError.textContent = 'Please enter a coupon code.';
            couponError.style.display = 'block';
            couponSuccess.style.display = 'none';
            return;
          }

          try {
            console.log('Sending fetch request to /validate-coupon', { couponCode, subtotal: originalSubtotal, userId });
            const response = await fetch('/validate-coupon', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ couponCode, subtotal: originalSubtotal, userId })
            });

            console.log('Fetch response status:', response.status, { ok: response.ok });

            if (!response.ok) {
              const errorText = await response.text();
              console.error('Validate coupon response error:', { status: response.status, errorText });
              throw new Error(`Server error: ${response.status} - ${errorText}`);
            }

            const result = await response.json();
            console.log('Validate coupon response:', result);

            if (!result.valid) {
              couponError.textContent = result.message || 'Invalid coupon code.';
              couponError.style.display = 'block';
              couponSuccess.style.display = 'none';
              return;
            }

            const discountPercentage = result.discount;
            const baseFinalTotal = originalSubtotal - originalItemDiscount + originalTax + deliveryCharge;
            const couponDiscount = baseFinalTotal * (discountPercentage / 100);
            const finalTotal = baseFinalTotal - couponDiscount;

            discountEl.textContent = couponDiscount.toFixed(2);
            finalTotalEl.textContent = finalTotal.toFixed(2);
            couponInput.value = couponCode;
            appliedCouponCode = couponCode;
            this.textContent = 'Remove';
            couponError.style.display = 'none';
            couponSuccess.textContent = `Coupon applied! ${discountPercentage}% off (₹${couponDiscount.toFixed(2)})`;
            couponSuccess.style.display = 'block';
            setTimeout(() => couponSuccess.style.display = 'none', 3000);
            console.log('Coupon applied:', { couponDiscount, finalTotal, baseFinalTotal });
          } catch (err) {
            console.error('Error applying coupon:', {
              message: err.message,
              couponCode,
              subtotal: originalSubtotal,
              userId
            });
            couponError.textContent = err.message.includes('Invalid or expired coupon') 
              ? 'Invalid or expired coupon.' 
              : err.message.includes('User not logged in') 
              ? 'Please log in to apply coupons.'
              : err.message.includes('You have reached the usage limit') 
              ? 'You have reached the usage limit for this coupon.'
              : 'Error validating coupon. Please try again.';
            couponError.style.display = 'block';
            couponSuccess.style.display = 'none';
          }
        } else {
          couponInput.value = '';
          appliedCouponCode = '';
          discountEl.textContent = '0.00';
          finalTotalEl.textContent = (originalSubtotal - originalItemDiscount + originalTax + deliveryCharge).toFixed(2);
          this.textContent = 'Apply';
          couponError.style.display = 'none';
          couponSuccess.textContent = 'Coupon removed.';
          couponSuccess.style.display = 'block';
          setTimeout(() => couponSuccess.style.display = 'none', 3000);
          console.log('Coupon removed');
        }
      });

      // Prevent form submission on Enter key in coupon input
      couponInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          console.log('Enter key pressed on coupon input');
          couponButton.click();
        }
      });
    });
  </script>
</body>
<%- include('../partials/user/footer') %>