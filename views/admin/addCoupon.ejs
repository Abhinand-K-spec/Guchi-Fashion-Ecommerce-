<%- include("../partials/admin/header") %>


    <head>
        <title>Coupon Management - Admin Panel</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
        <style>
            body {
                background-color: #1a1b26;
                color: #fff;
            }

            .card {
                background-color: #242531;
                border: 1px solid rgba(255, 255, 255, 0.08);
                border-radius: 10px;
            }

            .form-control {
                background-color: #2c2e3e;
                border: 1px solid rgba(255, 255, 255, 0.1);
                color: #e5e7eb;
            }

            .form-control:focus {
                background-color: #2c2e3e;
                border-color: #3b82f6;
                color: #ffffff;
                box-shadow: none;
            }

            .form-control::placeholder {
                color: #9ca3af;
            }

            .table-dark-custom {
                background-color: transparent !important;
                --bs-table-bg: transparent;
                color: #e5e7eb;
            }

            .table-dark-custom td,
            .table-dark-custom th {
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
                padding: 12px 16px;
                vertical-align: middle;
                color: #e5e7eb;
            }

            .error {
                color: #ef4444;
                font-size: 0.875rem;
                margin-top: 0.25rem;
                display: none;
            }
        </style>
    </head>

    <body>
        <div class="container-fluid py-4">

            <div class="card mb-4">
                <div class="card-header bg-transparent border-bottom border-secondary py-3">
                    <h5 class="mb-0 text-white">Add New Coupon</h5>
                </div>
                <div class="card-body">
                    <form id="couponForm" onsubmit="handleCouponSubmit(event)">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label text-white-50 small text-uppercase fw-bold">Coupon Name</label>
                                <input type="text" class="form-control" id="couponName" name="CouponName"
                                    placeholder="e.g. Summer Sale">
                                <span class="error" id="couponNameError">Coupon Name is required</span>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label text-white-50 small text-uppercase fw-bold">Coupon Code</label>
                                <input type="text" class="form-control" id="couponCode" name="CouponCode"
                                    placeholder="e.g. SUMMER2024">
                                <span class="error" id="couponCodeError">Enter 4+ alphanumeric characters</span>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label text-white-50 small text-uppercase fw-bold">Discount
                                    (%)</label>
                                <input type="number" class="form-control" id="discount" name="Discount"
                                    placeholder="0-90">
                                <span class="error" id="discountError">0 - 90 only</span>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label text-white-50 small text-uppercase fw-bold">Start Date</label>
                                <input type="date" class="form-control" id="startDate" name="StartDate">
                                <span class="error" id="startDateError">Required</span>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label text-white-50 small text-uppercase fw-bold">End Date</label>
                                <input type="date" class="form-control" id="endDate" name="EndDate">
                                <span class="error" id="endDateError">Required</span>
                            </div>

                            <div class="col-12 mt-4 text-end">
                                <button type="submit" class="btn btn-primary px-4">Create Coupon</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Managment Section -->
            <div class="card">
                <div
                    class="card-header bg-transparent border-bottom border-secondary py-3 d-flex flex-wrap justify-content-between align-items-center gap-3">
                    <h5 class="mb-0 text-white">Coupon Management</h5>

                    <div class="d-flex gap-2">
                        <input type="text" class="form-control form-control-sm" id="searchCoupons"
                            placeholder="Search coupons..." style="width: 200px;">
                        <button type="button" class="btn btn-sm btn-outline-primary"
                            onclick="searchCoupons()">Search</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary"
                            onclick="clearSearch()">Clear</button>
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark-custom table-hover mb-0">
                            <thead>
                                <tr>
                                    <th class="text-uppercase small text-white-50">Name</th>
                                    <th class="text-uppercase small text-white-50">Code</th>
                                    <th class="text-uppercase small text-white-50">Discount</th>
                                    <th class="text-uppercase small text-white-50">Start</th>
                                    <th class="text-uppercase small text-white-50">End</th>
                                    <th class="text-uppercase small text-white-50">Status</th>
                                    <th class="text-uppercase small text-white-50 text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="couponTable">
                                <% coupons.forEach(coupon=> { %>
                                    <tr id="coupon-<%= coupon._id %>">
                                        <td class="fw-bold">
                                            <%= coupon.CouponName %>
                                        </td>
                                        <td><span class="badge bg-secondary bg-opacity-25 text-secondary">
                                                <%= coupon.CouponCode %>
                                            </span></td>
                                        <td>
                                            <%= coupon.Discount %>%
                                        </td>
                                        <td>
                                            <%= new Date(coupon.StartDate).toLocaleDateString() %>
                                        </td>
                                        <td>
                                            <%= new Date(coupon.ExpiryDate).toLocaleDateString() %>
                                        </td>
                                        <td class="status">
                                            <% if(coupon.IsListed) { %>
                                                <span class="badge bg-success bg-opacity-25 text-success">Listed</span>
                                                <% } else { %>
                                                    <span
                                                        class="badge bg-danger bg-opacity-25 text-danger">Unlisted</span>
                                                    <% } %>
                                        </td>
                                        <td class="text-end">
                                            <button type="button"
                                                class="btn btn-sm <%= coupon.IsListed ? 'btn-danger' : 'btn-success' %>"
                                                onclick="toggleCouponStatus('<%= coupon._id %>', <%= coupon.IsListed %>)">
                                                <%= coupon.IsListed ? "Unlist" : "List" %>
                                            </button>
                                        </td>
                                    </tr>
                                    <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-transparent border-top border-secondary py-3">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center mb-0">
                            <% if (hasPrevPage) { %>
                                <li class="page-item">
                                    <button class="page-link bg-dark border-secondary text-white"
                                        onclick="window.location.href='/admin/coupons?page=<%= currentPage - 1 %>'">Previous</button>
                                </li>
                                <% } %>

                                    <% for (let i=1; i<=totalPages; i++) { %>
                                        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                                            <button
                                                class="page-link <%= currentPage === i ? 'bg-primary border-primary' : 'bg-dark border-secondary' %> text-white"
                                                onclick="window.location.href='/admin/coupons?page=<%= i %>'">
                                                <%= i %>
                                            </button>
                                        </li>
                                        <% } %>

                                            <% if (hasNextPage) { %>
                                                <li class="page-item">
                                                    <button class="page-link bg-dark border-secondary text-white"
                                                        onclick="window.location.href='/admin/coupons?page=<%= currentPage + 1 %>'">Next</button>
                                                </li>
                                                <% } %>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>


        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

        <script>


            function showToast(message, isError = false) {
                Toastify({
                    text: message,
                    duration: 3000,
                    gravity: "bottom",
                    position: "right",
                    close: true,
                    style: {
                        background: isError ? "#dc3545" : "#28a745",
                        color: "#fff",
                        borderRadius: "6px",
                        padding: "10px 16px",
                        fontSize: "15px"
                    }
                }).showToast();
            }


            function validateForm() {
                let ok = true;

                if (!couponName.value.trim()) ok = showErr("couponNameError");
                if (!couponCode.value.trim() || couponCode.value.length < 4) ok = showErr("couponCodeError");
                if (!startDate.value) ok = showErr("startDateError");
                if (!endDate.value) ok = showErr("endDateError");
                if (discount.value < 0 || discount.value > 90) ok = showErr("discountError");

                return ok;
            }

            function showErr(id) {
                document.getElementById(id).style.display = "block";
                return false;
            }


            async function handleCouponSubmit(event) {
                event.preventDefault();
                if (!validateForm()) return;

                const data = Object.fromEntries(new FormData(couponForm));
                data.CouponCode = data.CouponCode.toUpperCase();

                try {
                    const res = await axios.post("/admin/addCoupon", data, { validateStatus: (status) => status !== 500 });

                    if (res.data.success) {
                        showToast("Coupon created successfully");
                        addCouponToTable(res.data.coupon);
                        couponForm.reset();
                    } else if (res.data.error) {
                        showToast(res.data.error, true);

                    } else {
                        showToast(res.data.error || res.error || "Something went wrong", true);
                    }
                } catch (err) {
                    const msg =
                        err.response?.data?.error ||
                        err.response?.data?.message ||
                        err.response?.data?.msg ||
                        "Server error";

                    showToast(msg, true);
                }
            }


            function addCouponToTable(c) {
                const row = `
    <tr id="coupon-${c._id}">
        <td>${c.CouponName}</td>
        <td>${c.CouponCode}</td>
        <td>${c.Discount}</td>
        <td>${new Date(c.StartDate).toLocaleDateString()}</td>
        <td>${new Date(c.ExpiryDate).toLocaleDateString()}</td>
        <td class="status">${c.IsListed ? "Listed" : "Unlisted"}</td>
        <td>
            <button type="button" class="btn btn-danger"
                onclick="toggleCouponStatus('${c._id}', ${c.IsListed})">
                ${c.IsListed ? "Unlist" : "List"}
            </button>
        </td>
    </tr>`;

                couponTable.innerHTML = row + couponTable.innerHTML;
            }


            async function toggleCouponStatus(id, current) {
                const action = current ? "unlistCoupon" : "listCoupon";

                try {
                    const res = await axios.post(`/admin/${action}/${id}`);

                    showToast(res.data.message);
                    updateCouponStatus(id, !current);
                } catch (err) {
                    console.log("CAUGHT ERROR:", err.response?.data);
                    const msg =
                        err.response?.data?.error ||
                        err.response?.data?.message ||
                        responsse.error ||
                        "Error creating coupon";
                    showToast(msg, true);
                }
            }

            function updateCouponStatus(id, status) {
                const row = document.getElementById(`coupon-${id}`);
                row.querySelector(".status").innerText = status ? "Listed" : "Unlisted";

                const btn = row.querySelector("button");
                btn.innerText = status ? "Unlist" : "List";
                btn.setAttribute("onclick", `toggleCouponStatus('${id}', ${status})`);
            }


            function searchCoupons() {
                const term = document.getElementById("searchCoupons").value.toLowerCase();

                document.querySelectorAll("#couponTable tr").forEach(row => {
                    row.style.display = row.innerText.toLowerCase().includes(term) ? "" : "none";
                });
            }

            function clearSearch() {
                document.getElementById("searchCoupons").value = "";
                document.querySelectorAll("#couponTable tr").forEach(row => {
                    row.style.display = "";
                });
            }


            document.getElementById("couponName").addEventListener("input", () => {
                const v = couponName.value.trim();
                document.getElementById("couponNameError").style.display = v ? "none" : "block";
            });

            document.getElementById("couponCode").addEventListener("input", () => {
                const valid = /^[A-Za-z0-9]{4,}$/.test(couponCode.value.trim());
                document.getElementById("couponCodeError").style.display = valid ? "none" : "block";
            });

            document.getElementById("startDate").addEventListener("change", () => {
                document.getElementById("startDateError").style.display = startDate.value ? "none" : "block";
            });

            document.getElementById("endDate").addEventListener("change", () => {
                const start = new Date(startDate.value);
                const end = new Date(endDate.value);
                const error = (!endDate.value || end < start);
                document.getElementById("endDateError").style.display = error ? "block" : "none";
            });

            document.getElementById("discount").addEventListener("input", () => {
                const v = parseFloat(discount.value);
                const valid = !isNaN(v) && v >= 0 && v <= 100;
                document.getElementById("discountError").style.display = valid ? "none" : "block";
            });

        </script>


    </body>

    </html>