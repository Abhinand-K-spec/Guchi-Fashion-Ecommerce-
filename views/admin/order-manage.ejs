<%- include('../partials/admin/header') %>

  <!DOCTYPE html>
  <html lang="en">

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #1a1b26;
        color: #eaeaea;
      }

      .card {
        background-color: #242531;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
      }

      .form-control,
      .form-select {
        background-color: #2c2e3e;
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #e5e7eb;
      }

      .form-control:focus,
      .form-select:focus {
        background-color: #2c2e3e;
        border-color: #3b82f6;
        color: #ffffff;
        box-shadow: none;
      }

      .form-control::placeholder {
        color: #9ca3af;
      }

      .btn-primary {
        background-color: #0a84ff;
        border: none;
      }

      .btn-primary:hover {
        background-color: #0066cc;
      }

      .btn-outline-secondary {
        border-color: rgba(255, 255, 255, 0.1);
        color: #e5e7eb;
      }

      .btn-outline-secondary:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: #fff;
      }

      .table-dark-custom {
        background-color: transparent !important;
        --bs-table-bg: transparent;
        color: #e5e7eb;
      }

      .table-dark-custom td,
      .table-dark-custom th {
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        padding: 12px 16px;
        vertical-align: middle;
        color: #e5e7eb;
      }

      .pagination .active .page-link {
        background-color: #0a84ff;
        border-color: #0a84ff;
        color: white;
      }

      .page-link {
        background-color: #2c2e3e;
        border-color: rgba(255, 255, 255, 0.1);
        color: #e5e7eb;
      }

      .page-link:hover {
        background-color: #3a3b4c;
        border-color: rgba(255, 255, 255, 0.1);
        color: #fff;
      }

      /* Order Status Badges */
      .badge {
        font-weight: 500;
        padding: 6px 10px;
      }

      .bg-success {
        background-color: rgba(16, 185, 129, 0.2) !important;
        color: #10b981 !important;
      }

      .bg-danger {
        background-color: rgba(239, 68, 68, 0.2) !important;
        color: #ef4444 !important;
      }

      .bg-warning {
        background-color: rgba(245, 158, 11, 0.2) !important;
        color: #f59e0b !important;
      }

      .bg-info {
        background-color: rgba(59, 130, 246, 0.2) !important;
        color: #3b82f6 !important;
      }

      .bg-secondary {
        background-color: rgba(107, 114, 128, 0.2) !important;
        color: #9ca3af !important;
      }

      .bg-primary {
        background-color: rgba(10, 132, 255, 0.2) !important;
        color: #0a84ff !important;
      }
    </style>
  </head>

  <body>

    <div class="container-fluid py-4">
      <div class="card">
        <div
          class="card-header bg-transparent border-bottom border-secondary py-3 d-flex flex-wrap justify-content-between align-items-center gap-3">
          <h5 class="mb-0 text-white">Order Management</h5>

          <form method="GET" class="d-flex flex-wrap gap-2" action="/admin/orders">
            <input type="text" class="form-control form-control-sm" name="search" placeholder="Search Order ID"
              value="<%= search %>" style="width: 200px;">
            <select name="status" class="form-select form-select-sm" style="width: 180px;">
              <option value="">All Status</option>
              <option value="Pending" <%=status==='Pending' ? 'selected' : '' %>>Pending</option>
              <option value="Partially Delivered" <%=status==='Partially Delivered' ? 'selected' : '' %>>Partially
                Delivered</option>
              <option value="Delivered" <%=status==='Delivered' ? 'selected' : '' %>>Delivered</option>
              <option value="Cancelled" <%=status==='Cancelled' ? 'selected' : '' %>>Cancelled</option>
              <option value="Returned" <%=status==='Returned' ? 'selected' : '' %>>Returned</option>
              <option value="Partially Returned" <%=status==='Partially Returned' ? 'selected' : '' %>>Partially
                Returned</option>
              <option value="Payment Failed" <%=status==='Payment Failed' ? 'selected' : '' %>>Payment Failed</option>
            </select>
            <button type="submit" class="btn btn-sm btn-primary">Search</button>
            <a href="/admin/orders" class="btn btn-sm btn-outline-secondary">Clear</a>
          </form>
        </div>

        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-dark-custom table-hover mb-0">
              <thead>
                <tr>
                  <th class="text-uppercase small text-white-50">Order ID</th>
                  <th class="text-uppercase small text-white-50">User</th>
                  <th class="text-uppercase small text-white-50">Date</th>
                  <th class="text-uppercase small text-white-50">Status</th>
                  <th class="text-uppercase small text-white-50 text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                <% if (orders.length===0) { %>
                  <tr>
                    <td colspan="5" class="text-center py-4 text-muted">No orders found</td>
                  </tr>
                  <% } else { %>
                    <% orders.forEach(order=> { %>
                      <tr>
                        <td class="fw-bold">
                          <%= order.OrderId %>
                        </td>
                        <td>
                          <%= order.UserId?.name || 'Unknown' %>
                        </td>
                        <td>
                          <%= new Date(order.OrderDate).toLocaleDateString() %>
                        </td>
                        <td>
                          <% const statuses=order.Items.map(i=> i.status);
                            let computedStatus = "";

                            if (order.PaymentStatus === "Pending" && order.PaymentMethod== 'Online') {
                            computedStatus = "Payment Failed";
                            } else if (statuses.every(s => s === "Delivered")) {
                            computedStatus = "Delivered";
                            } else if (statuses.every(s => s === "Cancelled")) {
                            computedStatus = "Cancelled";
                            } else if (statuses.every(s => s === "Returned")) {
                            computedStatus = "Returned";
                            } else if (statuses.includes("Delivered") && statuses.includes("Pending")) {
                            computedStatus = "Partially Delivered";
                            } else if (statuses.includes("Returned") && statuses.includes("Delivered")) {
                            computedStatus = "Partially Returned";
                            } else if (statuses.includes("Pending")) {
                            computedStatus = "Pending";
                            } else {
                            computedStatus = statuses[0] || "Pending";
                            }
                            %>

                            <% if (computedStatus==='Delivered' ) { %>
                              <span class="badge bg-success">Delivered</span>
                              <% } else if (computedStatus==='Cancelled' ) { %>
                                <span class="badge bg-danger">Cancelled</span>
                                <% } else if (computedStatus==='Returned' ) { %>
                                  <span class="badge bg-warning">Returned</span>
                                  <% } else if (computedStatus==='Partially Delivered' ) { %>
                                    <span class="badge bg-info">Partially Delivered</span>
                                    <% } else if (computedStatus==='Partially Returned' ) { %>
                                      <span class="badge bg-secondary">Partially Returned</span>
                                      <% } else if (computedStatus==='Payment Failed' ) { %>
                                        <span class="badge bg-danger">Payment Failed</span>
                                        <% } else if (computedStatus==='Pending' ) { %>
                                          <span class="badge bg-warning">Pending</span>
                                          <% } else { %>
                                            <span class="badge bg-primary">
                                              <%= computedStatus %>
                                            </span>
                                            <% } %>
                        </td>
                        <td class="text-end">
                          <a href="/admin/order-details/<%= order._id %>" class="btn btn-sm btn-outline-primary">View
                            Details</a>
                        </td>
                      </tr>
                      <% }) %>
                        <% } %>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card-footer bg-transparent border-top border-secondary py-3">
          <% if (totalPages> 1) { %>
            <nav>
              <ul class="pagination justify-content-center mb-0">
                <% for (let i=1; i <=totalPages; i++) { %>
                  <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                    <a class="page-link" href="?page=<%= i %>&search=<%= search %>&status=<%= status %>">
                      <%= i %>
                    </a>
                  </li>
                  <% } %>
              </ul>
            </nav>
            <% } %>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>

  </html>
  <%- include('../partials/admin/footer') %>