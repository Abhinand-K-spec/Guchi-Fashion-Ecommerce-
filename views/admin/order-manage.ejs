<%- include('../partials/admin/header') %>

<style>
  body {
    background-color: #121212 !important;
    color: #ffffff !important;
    font-family: 'Inter', sans-serif;
  }

  .container {
    background-color: #1c1c1c;
    border-radius: 12px;
    padding: 30px;
    margin-top: 30px;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
  }

  h3 {
    color: #fff;
  }

  .table {
    color: black;
    border-color: #555;
    background-color: #2a2a2a;
  }

  .table th {
    background-color: #0d6efd;
    color: white;
    text-align: center;
  }

  .table td {
    vertical-align: middle;
    background-color: black;
    color: white;
    border-color: #555;
    text-align: center;
    background-color: #1c1c1c;
    color: #e0e0e0;
  }

  .form-control,
  .btn,
  select {
    border-radius: 6px;
  }

  .form-control {
    background-color: #2a2a2a;
    color: #ffffff;
    border: 1px solid #444;
  }

  .form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
  }

  select.form-control {
    background-color: #2a2a2a;
    color: #fff;
  }

  option {
    background-color: #1c1c1c;
    color: #fff;
  }

  .searchinput {
    background-color: #2a2a2a;
    color: #fff;
    border: 1px solid #444;
    padding: 8px 12px;
  }

  .btn-primary,
  .btn-info {
    background-color: #0d6efd;
    border: none;
    color: #fff;
  }

  .btn-secondary {
    background-color: #6c757d;
    border: none;
    color: #fff;
  }

  .btn-primary:hover,
  .btn-info:hover {
    background-color: #0b5ed7;
  }

  .btn-secondary:hover {
    background-color: #5a6268;
  }

  .badge {
    padding: 0.5em 0.75em;
    font-size: 0.85em;
    font-weight: 500;
    border-radius: 8px;
  }

  .pagination .page-link {
    background-color: #2a2a2a;
    color: #fff;
    border: 1px solid #444;
  }

  .pagination .page-item.active .page-link {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: #fff;
  }

  .pagination .page-link:hover {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: #fff;
  }
</style>


<div class="container">
  <h3 class="mb-4 text-white">Order Management</h3>

  <!-- ðŸ” Search and Filter -->
  <form method="GET" class="d-flex gap-3 mb-4" action="/admin/orders">
    <input type="text" class="searchinput" name="search" placeholder="Search Order ID" value="<%= search %>">
    <select name="status" class="form-control">
      <option value="">All Status</option>
    
      <option value="Pending" <%= status === 'Pending' ? 'selected' : '' %>>Pending</option>
      <option value="Partially Delivered" <%= status === 'Partially Delivered' ? 'selected' : '' %>>Partially Delivered</option>
      <option value="Delivered" <%= status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
    
      <option value="Cancelled" <%= status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
    
      <option value="Returned" <%= status === 'Returned' ? 'selected' : '' %>>Returned</option>
      <option value="Partially Returned" <%= status === 'Partially Returned' ? 'selected' : '' %>>Partially Returned</option>
    
      <option value="Payment Failed" <%= status === 'Payment Failed' ? 'selected' : '' %>>Payment Failed</option>
    </select>
    
    <button type="submit" class="btn btn-primary">Search</button>
    <a href="/admin/orders" class="btn btn-secondary">Clear</a>
  </form>

  <!-- ðŸ“¦ Orders Table -->
  <table class="table table-bordered table-hover">
    <thead>
      <tr>
        <th>Order ID</th>
        <th>User</th>
        <th>Date</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% if (orders.length === 0) { %>
        <tr>
          <td colspan="5">No orders found</td>
        </tr>
      <% } else { %>
        <% orders.forEach(order => { %>
          <tr>
            <td><%= order.OrderId %></td>
            <td><%= order.UserId?.name || 'Unknown' %></td>
            <td><%= new Date(order.OrderDate).toLocaleDateString() %></td>
            <td>
              <% 
                const statuses = order.Items.map(i => i.status);
            
                let computedStatus = "";
            
                if (order.PaymentStatus === "Pending" && order.PaymentMethod== 'Online') {
                  computedStatus = "Payment Failed";
                } else if (statuses.every(s => s === "Delivered")) {
                  computedStatus = "Delivered";
                } else if (statuses.every(s => s === "Cancelled")) {
                  computedStatus = "Cancelled";
                } else if (statuses.every(s => s === "Returned")) {
                  computedStatus = "Returned";
                } else if (statuses.includes("Delivered") && statuses.includes("Pending")) {
                  computedStatus = "Partially Delivered";
                } else if (statuses.includes("Returned") && statuses.includes("Delivered")) {
                  computedStatus = "Partially Returned";
                } else if (statuses.includes("Pending")) {
                  computedStatus = "Pending";
                } else {
                  computedStatus = statuses[0] || "Pending";
                }
              %>
            
              <% if (computedStatus === 'Delivered') { %>
                <span class="badge bg-success">Delivered</span>
            
              <% } else if (computedStatus === 'Cancelled') { %>
                <span class="badge bg-danger">Cancelled</span>
            
              <% } else if (computedStatus === 'Returned') { %>
                <span class="badge bg-warning text-dark">Returned</span>
            
              <% } else if (computedStatus === 'Partially Delivered') { %>
                <span class="badge bg-info text-dark">Partially Delivered</span>
            
              <% } else if (computedStatus === 'Partially Returned') { %>
                <span class="badge bg-secondary">Partially Returned</span>
            
              <% } else if (computedStatus === 'Payment Failed') { %>
                <span class="badge bg-danger">Payment Failed</span>
            
              <% } else if (computedStatus === 'Pending') { %>
                <span class="badge bg-warning text-dark">Pending</span>
            
              <% } else { %>
                <span class="badge bg-primary"><%= computedStatus %></span>
              <% } %>
            </td>
            
            <td>
              <a href="/admin/order-details/<%= order._id %>" class="btn btn-sm btn-info">View</a>
            </td>
          </tr>
        <% }) %>
      <% } %>
    </tbody>
  </table>

  <!-- Pagination -->
  <% if (totalPages > 1) { %>
    <nav>
      <ul class="pagination justify-content-center">
        <% for (let i = 1; i <= totalPages; i++) { %>
          <li class="page-item <%= currentPage === i ? 'active' : '' %>">
            <a class="page-link" href="?page=<%= i %>&search=<%= search %>&status=<%= status %>"><%= i %></a>
          </li>
        <% } %>
      </ul>
    </nav>
  <% } %>
</div>

<%- include('../partials/admin/footer') %>