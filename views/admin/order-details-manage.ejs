<%- include('../partials/admin/header') %>
  <!DOCTYPE html>
  <html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <style>
      body {
        background-color: #1a1b26;
        font-family: 'Inter', sans-serif;
        color: #eaeaea;
      }

      .card {
        background-color: #242531;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
      }

      .text-white-50 {
        color: rgba(255, 255, 255, 0.5) !important;
      }

      .form-control,
      .form-select {
        background-color: #2c2e3e;
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #e5e7eb;
      }

      .form-control:focus,
      .form-select:focus {
        background-color: #2c2e3e;
        border-color: #3b82f6;
        color: #ffffff;
        box-shadow: none;
      }

      .btn-outline-light {
        border-color: rgba(255, 255, 255, 0.2);
        color: #e5e7eb;
      }

      .btn-outline-light:hover {
        background-color: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.3);
      }

      .img-fluid {
        max-height: 80px;
        object-fit: cover;
        border-radius: 6px;
      }

      .price-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
        padding-bottom: 0.25rem;
      }

      .price-row:last-child {
        border-bottom: none;
      }

      .badge {
        font-weight: 500;
      }
      #ct{
        padding-top: 10vh;
      }
    </style>
  </head>

  <body>

    <div class="container py-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="text-white mb-0 fs-4">Order Details</h3>
        <a href="/admin/orders" class="btn btn-outline-light btn-sm">
          <i class="fas fa-arrow-left me-2"></i>Back
        </a>
      </div>

      <% if (order) { %>
        <div id="ct" class="row g-3">
          <!-- Order Info -->
          <div class="col-lg-8">
            <div class="card mb-3 text-white border-0" style="background-color: #242531;">
              <div class="card-header bg-transparent border-bottom border-secondary py-3">
                <h5 class="mb-0 text-white fs-5 mt-1">Order #<%= order.OrderId %>
                </h5>
              </div>
              <div class="card-body p-3">
                <div class="row g-3">
                  <div class="col-md-6">
                    <h6 class="text-secondary text-uppercase small fw-bold mb-2"
                      style="font-size: 0.75rem; letter-spacing: 0.5px;">Customer Details</h6>
                    <p class="mb-0 fw-bold fs-6">
                      <%= order.UserId?.name || 'N/A' %>
                    </p>
                    <p class="mb-0 text-white-50 small">
                      <%= order.UserId?.email || 'N/A' %>
                    </p>
                    <p class="mb-0 text-white-50 small">Placed on: <%= new Date(order.OrderDate).toLocaleString() %>
                    </p>
                    <% if (order.CancelReason) { %>
                      <p class="text-danger mt-1 small"><strong>Cancelled:</strong>
                        <%= order.CancelReason %>
                      </p>
                      <% } %>
                  </div>
                  <div class="col-md-6">
                    <h6 class="text-secondary text-uppercase small fw-bold mb-2"
                      style="font-size: 0.75rem; letter-spacing: 0.5px;">Shipping Address</h6>
                    <p class="mb-0 small text-white">
                      <%= order.Address?.name || 'N/A' %><br>
                        <%= order.Address?.line1 || '' %>, <%= order.Address?.city || '' %><br>
                            <%= order.Address?.state || '' %> - <%= order.Address?.postCode || '' %>
                    </p>
                    <p class="mb-0 small text-white">Phone: <%= order.Address?.phone || 'N/A' %>
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Items -->
            <div class="card text-white border-0" style="background-color: #242531;">
              <div class="card-header bg-transparent border-bottom border-secondary py-2">
                <h5 class="mb-0 text-white fs-5">Ordered Items</h5>
                <div class="small text-success mt-1">Payment: <strong>
                    <%= order.PaymentMethod %>
                  </strong></div>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-dark table-borderless align-middle mb-0"
                    style="--bs-table-bg: transparent;">
                    <thead class="border-bottom border-secondary" style="background-color: rgba(255,255,255,0.02);">
                      <tr class="text-white-50 small text-uppercase">
                        <th class="ps-3 py-2 fw-medium">Product</th>
                        <th class="py-2 fw-medium text-center">Price/Qty</th>
                        <th class="py-2 fw-medium text-center">Total</th>
                        <th class="py-2 fw-medium text-center">Status</th>
                        <th class="text-end pe-3 py-2 fw-medium">Actions</th>
                      </tr>
                    </thead>
                    <tbody class="text-white">
                      <% order.Items.forEach(item=> {
                        const product = item.product || {};
                        const variantIndex = item.variantIndex !== undefined ? item.variantIndex : 0;
                        const variant = product.Variants?.[variantIndex] || {};
                        %>
                        <tr class="border-bottom border-secondary" id="item-<%= item._id %>">
                          <td class="ps-3 py-3">
                            <div class="d-flex align-items-center">
                              <img src="<%= item.product?.Image?.[0] || 'default.jpg' %>" class="img-fluid me-3"
                                style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;" alt="Product">
                              <div>
                                <div class="fw-bold text-white mb-0" style="font-size: 0.9rem;">
                                  <%= item.product?.productName || 'Unknown' %>
                                </div>
                                <div class="text-white-50 small">Size: <%= variant.Size || 'N/A' %>
                                </div>
                              </div>
                            </div>
                          </td>
                          <td class="py-3 text-center">
                            <div class="small text-white">₹<%= (item.originalPrice || 0).toFixed(2) %>
                            </div>
                            <div class="small text-white-50">x <%= item.quantity %>
                            </div>
                          </td>
                          <td class="py-3 text-center">
                            <div class="fw-bold text-white small">₹<%= (item.finalPayableAmount || ((item.originalPrice
                                || 0) * item.quantity)).toFixed(2) %>
                            </div>
                            <% if ((item.offerDiscountAmount || 0)> 0) { %>
                              <div class="small text-success" style="font-size: 0.75rem;">-₹<%=
                                  item.offerDiscountAmount.toFixed(2) %>
                              </div>
                              <% } %>
                          </td>
                          <td class="py-3 text-center">
                            <% if(order.PaymentMethod==='Online' && order.PaymentStatus!=='Completed' &&
                              order.Status==='Pending' ) { %>
                              <span class="badge bg-danger">Payment Failed</span>
                              <% } else { %>
                                <span class="badge 
                                              <% if(item.status === 'Delivered') { %> bg-success
                                              <% } else if(item.status === 'Cancelled') { %> bg-danger
                                              <% } else if(item.status === 'Shipped') { %> bg-primary
                                              <% } else if(item.status === 'OutForDelivery') { %> bg-info text-dark
                                              <% } else if(item.status === 'Returned') { %> bg-warning text-dark
                                              <% } else { %> bg-secondary <% } %>" id="item-status-<%= item._id %>">
                                  <%= item.status %>
                                </span>
                                <% } %>

                                  <% if (item.returnStatus !=='NotRequested' ) { %>
                                    <div class="mt-1">
                                      <span class="badge 
                                                    <% if(item.returnStatus === 'Return Requested') { %> bg-warning text-dark
                                                    <% } else if(item.returnStatus === 'Request Approved') { %> bg-success
                                                    <% } else if(item.returnStatus === 'Request Denied') { %> bg-danger
                                                    <% } %>">
                                        <%= item.returnStatus %>
                                      </span>
                                    </div>
                                    <% } %>
                          </td>
                          <td class="text-end pe-4">
                            <% if (item.status !=='Cancelled' && item.status !=='Delivered' && item.status !=='Returned'
                              && item.returnStatus !=='Return Requested' && item.returnStatus !=='Request Approved' ) {
                              %>
                              <form class="update-item-status-form d-inline-block mb-1" data-item-id="<%= item._id %>"
                                action="/admin/order-details/<%= order._id %>/update-item-status/<%= item._id %>"
                                method="POST">
                                <select name="status" class="form-select form-select-sm d-inline-block w-auto"
                                  style="min-width: 120px;">
                                  <option value="Pending" <%=item.status==='Pending' ? 'selected' : '' %>>Pending
                                  </option>
                                  <option value="Shipped" <%=item.status==='Shipped' ? 'selected' : '' %>>Shipped
                                  </option>
                                  <option value="OutForDelivery" <%=item.status==='OutForDelivery' ? 'selected' : '' %>
                                    >Out for Delivery</option>
                                  <option value="Delivered" <%=item.status==='Delivered' ? 'selected' : '' %>>Delivered
                                  </option>
                                  <option value="Cancelled" <%=item.status==='Cancelled' ? 'selected' : '' %>>Cancelled
                                  </option>
                                </select>
                              </form>
                              <% } %>

                                <% if (order.Status==='Pending' && item.status !=='Cancelled' &&
                                  item.returnStatus==='NotRequested' && item.status !=='Delivered' &&
                                  order.paymentStatus==='Confirmed' ) { %>
                                  <form class="cancel-item-form d-inline-block" data-item-id="<%= item._id %>"
                                    action="/admin/order-details/<%= order._id %>/cancel-item/<%= item._id %>"
                                    method="POST">
                                    <button type="button" class="btn btn-outline-danger btn-sm"
                                      onclick="showCancelModal(this)">Cancel</button>
                                    <!-- Hidden input populated by modal -->
                                    <input type="hidden" name="reason" class="cancel-reason-input">
                                  </form>
                                  <% } %>

                                    <% if (item.returnStatus==='Return Requested' && item.status !=='Cancelled' ) { %>
                                      <div class="d-flex flex-column gap-1 align-items-end">
                                        <form
                                          action="/admin/approve-return/<%= order._id %>?productId=<%= item.product?._id %>"
                                          method="POST">
                                          <button class="btn btn-success btn-sm w-100">Approve</button>
                                        </form>
                                        <form
                                          action="/admin/reject-return/<%= order._id %>?productId=<%= item.product?._id %>"
                                          method="POST">
                                          <button class="btn btn-danger btn-sm w-100">Reject</button>
                                        </form>
                                      </div>
                                      <% } %>

                                        <% if (item.cancelReason) { %>
                                          <div class="small text-danger mt-1">Reason: <%= item.cancelReason %>
                                          </div>
                                          <% } %>
                                            <% if (item.returnReason) { %>
                                              <div class="small text-warning mt-1">Return Reason: <%= item.returnReason
                                                  %>
                                              </div>
                                              <% } %>
                          </td>
                        </tr>
                        <% }) %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Summary Sidebar -->
          <div class="col-lg-4">
            <div class="card sticky-top text-white" style="top: 20px; z-index: 1;">
              <div class="card-header bg-transparent border-bottom border-secondary py-3">
                <h5 class="mb-0 text-white">Summary</h5>
              </div>
              <div class="card-body">
                <% const itemsTotal=order.Items.reduce((sum, item)=> sum + (item.finalPayableAmount || 0), 0);
                  const totalOfferDiscount = order.totalOfferDiscount || 0;
                  const totalCouponDiscount = order.totalCouponDiscount || 0;
                  const totalSavings = totalOfferDiscount + totalCouponDiscount;
                  const deliveryCharge = order.totalDeliveryCharge || 40;
                  const orderTotal = order.orderAmount || (itemsTotal + deliveryCharge);
                  %>
                  <div class="price-row">
                    <span class="text-white-50">Items Total</span>
                    <span>₹<%= itemsTotal.toFixed(2) %></span>
                  </div>
                  <div class="price-row">
                    <span class="text-white-50">Delivery Charge</span>
                    <span>₹<%= deliveryCharge.toFixed(2) %></span>
                  </div>

                  <% if (totalSavings> 0) { %>
                    <div class="price-row text-success">
                      <span>Total Savings</span>
                      <span>-₹<%= totalSavings.toFixed(2) %></span>
                    </div>
                    <% } %>

                      <div class="price-row border-0 mt-3 pt-2 border-top border-secondary">
                        <strong class="fs-5">Order Total</strong>
                        <strong class="fs-5">₹<%= orderTotal.toFixed(2) %></strong>
                      </div>
              </div>
            </div>
          </div>
        </div>
        <% } else { %>
          <div class="alert alert-danger">Order not found.</div>
          <% } %>

    </div>

    <!-- Cancel Reason Modal -->
    <div class="modal fade" id="cancelReasonModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Cancel Item</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <label class="form-label text-white-50">Reason for Cancellation</label>
            <input type="text" id="modalCancelReason" class="form-control" placeholder="Enter reason...">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-danger" onclick="submitCancelForm()">Confirm Cancel</button>
          </div>
        </div>
      </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
      function toast(msg, type = 'error') {
        Toastify({
          text: msg,
          duration: 3000,
          gravity: "top",
          position: "right",
          style: {
            background: type === 'success' ? "#10b981" : "#ef4444",
          }
        }).showToast();
      }

      let activeCancelForm = null;

      function showCancelModal(btn) {
        activeCancelForm = btn.closest('form');
        const modal = new bootstrap.Modal(document.getElementById('cancelReasonModal'));
        modal.show();
      }

      function submitCancelForm() {
        if (!activeCancelForm) return;
        const reason = document.getElementById('modalCancelReason').value;
        const input = activeCancelForm.querySelector('.cancel-reason-input');
        input.value = reason;

        // Trigger submit handler
        activeCancelForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));

        const modal = bootstrap.Modal.getInstance(document.getElementById('cancelReasonModal'));
        modal.hide();
        document.getElementById('modalCancelReason').value = '';
      }

      document.addEventListener('DOMContentLoaded', () => {

        // Handle Status Update
        document.querySelectorAll('.update-item-status-form select').forEach(select => {
          select.addEventListener('change', async (e) => {
            const form = e.target.closest('form');
            const itemId = form.dataset.itemId;
            const url = form.action;
            const status = e.target.value;

            try {
              const response = await axios.post(url, { status });
              if (response.data.success) {
                toast(response.data.message || 'Updated successfully', 'success');
                setTimeout(() => window.location.reload(), 1000); // Reload to reflect changes reliably
              } else {
                toast(response.data.message || 'Update failed');
              }
            } catch (err) {
              console.error(err);
              toast(err.response?.data?.message || 'Server error');
            }
          });
        });

        // Handle Cancellation
        document.querySelectorAll('.cancel-item-form').forEach(form => {
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const itemId = form.dataset.itemId;
            const url = form.action;
            const reason = form.querySelector('.cancel-reason-input').value;

            try {
              // Need to send as JSON or FormData depending on backend expectations. 
              // Previous implementation used FormData, let's stick to standard JSON for clearer API usage if possible, 
              // but matching previous:
              const formData = { reason: reason };

              const response = await axios.post(url, formData);

              if (response.data.success) {
                toast(response.data.message || 'Item cancelled', 'success');
                setTimeout(() => window.location.reload(), 1000);
              } else {
                toast(response.data.message || 'Cancellation failed');
              }
            } catch (err) {
              console.error(err);
              toast(err.response?.data?.message || 'Server error');
            }
          });
        });
      });
    </script>

    <%- include('../partials/admin/footer') %>
  </body>

  </html>